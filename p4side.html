<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>BUFFERING AT THE FOOD COURT: GOLDEN</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body {
            margin: 0; overflow: hidden;
            background-color: #111;
            font-family: 'VT323', monospace;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }

        #canvas-container { position: fixed; top: 0; left: 0; z-index: 1; }

        /* CRT SCANLINE EFFECT */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 99; pointer-events: none;
            mix-blend-mode: overlay;
            opacity: 0.6;
        }

        /* UI CONTAINER */
        #ui-layer {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 600px; z-index: 100;
            display: flex; flex-direction: column;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.8));
            transition: opacity 0.2s;
            pointer-events: none; 
        }

        .speaker-box {
            background: #FFE600; color: #111;
            padding: 5px 20px; font-size: 1.5rem; font-weight: bold;
            width: fit-content; border: 3px solid #fff;
            transform: skew(-15deg) translateX(10px);
            margin-bottom: -5px; z-index: 102; display: none;
        }

        .text-box {
            background: rgba(0, 0, 0, 0.9); border: 3px solid #FFE600;
            padding: 15px; color: #fff; font-size: 1.4rem; line-height: 1.2;
            min-height: 100px; clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
            pointer-events: auto; 
            position: relative;
        }

        .tap-indicator {
            position: absolute; bottom: 10px; right: 15px; color: #FFE600;
            font-size: 1.2rem;
            animation: blink 0.8s infinite;
        }
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* MINI GAME UI OVERLAYS */
        #minigame-ui {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            width: 90%; text-align: center; z-index: 110; display: none;
            pointer-events: none;
        }
        .game-instruction {
            font-size: 3.5rem; color: #FFE600; text-shadow: 4px 4px #000;
            font-weight: bold; line-height: 0.9;
            animation: pop 0.5s infinite alternate;
        }
        @keyframes pop { from { transform: scale(1) rotate(-2deg); } to { transform: scale(1.1) rotate(2deg); } }

        #tuning-container { pointer-events: auto; width: 100%; display: flex; flex-direction: column; align-items: center;}
        input[type=range] {
            width: 80%; height: 50px; margin-top: 20px;
            accent-color: #FFE600; cursor: pointer;
        }
        
        #version-tag {
            position: fixed; top: 5px; right: 5px; color: rgba(0,0,0,0.4); z-index: 200; font-size: 10px;
        }
    </style>
</head>
<body>

    <div id="version-tag">v5.0 - CITY UPDATE</div>
    <div class="scanlines"></div>
    <div id="canvas-container"></div>

    <div id="minigame-ui">
        <div id="game-title" class="game-instruction">GAME START!</div>
        
        <div id="tuning-container" style="display:none; margin-top:20px;">
            <p style="color:white; font-size:1.5rem; background:black; display:inline-block; padding:5px;">DRAG TO TUNE</p><br>
            <input type="range" id="tuner" min="0" max="100" value="0">
        </div>
    </div>

    <div id="ui-layer">
        <div id="speaker" class="speaker-box">SPEAKER</div>
        <div id="dialogue" class="text-box" onclick="handleInput()">
            <span id="typing-text">BUFFERING AT THE FOOD COURT<br>[TAP TO START]</span>
            <div class="tap-indicator" id="arrow">▼</div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. STORY & CONFIGURATION
        // ==========================================
        let gameState = "STORY"; 
        let inputLocked = false;
        
        const story = [
            { type: 'narration', text: "The Junes Food Court was perfect. Too perfect." },
            { type: 'narration', text: "The sky was stuck on 'Sunny Afternoon,' scrolling and snapping back every 12 seconds." },
            { type: 'narration', text: "The tables were shiny, and the steak skewers on Kanji Tatsumi's plate had been steaming for three hours.", effect: 'kanjiSteam' },
            { type: 'narration', text: "Also, he couldn't pick them up." },
            { type: 'dialogue', speaker: "Kanji", text: "This is bull. I can see 'em. I can smell 'em. Why can't I—", anim: 'shakeKanji' },
            
            // GAME 1: SKEWERS
            { type: 'minigame_skewer', text: "HELP KANJI GRAB THE MEAT!" },

            { type: 'dialogue', speaker: "Naoto", text: "It's a rendering issue.", anim: 'glitchNaoto' },
            { type: 'dialogue', speaker: "Kanji", text: "English, Pint-Size!", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Naoto", text: "We're stuck in the TV World because everyone's thinking about Senpai right now, not us." },
            { type: 'dialogue', speaker: "Kanji", text: "Oh. So we're like... background characters." },
            { type: 'dialogue', speaker: "Rise", text: "Cut content. We didn't make the guest list.", anim: 'sadRise' },
            { type: 'dialogue', speaker: "Kanji", text: "I bet Yosuke begged to go. 'Please, let me be useful, I promise I won't crash my bike!'" },
            { type: 'dialogue', speaker: "Naoto", text: "To be fair, statistically, Yosuke crashes his bike in seventy percent of our investigations." },
            { type: 'dialogue', speaker: "Rise", text: "Seventy? I thought it was higher.", anim: 'bounceRise' },
            
            { type: 'action', text: "A blue-and-white blur shot toward a screen and slammed face-first into it!", effect: 'teddieCrash' },
            { type: 'dialogue', speaker: "Teddie", text: "...Ow.", anim: 'spinTeddie' },
            { type: 'dialogue', speaker: "Rise", text: "No luck?" },
            { type: 'dialogue', speaker: "Teddie", text: "The signal's jammed! There's a barrier! A wall of pure indifference!", anim: 'shakeTeddie' },
            
            // GAME 2: SIGNAL BOOST
            { type: 'minigame_signal', text: "MASH TO OVERPOWER THE JAMMER!" },

            { type: 'dialogue', speaker: "Teddie", text: "The humans aren't thinking about us! They're too busy sewing dogs!", anim: 'spinTeddie' },
            { type: 'dialogue', speaker: "Naoto", text: "Felt Koromarus." },
            { type: 'dialogue', speaker: "Teddie", text: "Do you know what this means?! We're nobodies! We're—" },
            { type: 'dialogue', speaker: "Naoto", text: "Backup files." },
            { type: 'dialogue', speaker: "Teddie", text: "I WAS GOING TO SAY TRAGIC GHOSTS!" },
            { type: 'dialogue', speaker: "Rise", text: "We're not ghosts, Teddie. We're just... on standby." },
            { type: 'dialogue', speaker: "Kanji", text: "So what, we just sit here and wait? While Senpai and the others get to hang out in the real world?", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Rise", text: "With boba." },
            { type: 'dialogue', speaker: "Kanji", text: "And working chopsticks.", anim: 'shakeKanji' },
            { type: 'narration', text: "A beat of depressed silence." },
            { type: 'dialogue', speaker: "Naoto", text: "Actually, this is an excellent opportunity.", anim: 'nodNaoto' },
            { type: 'dialogue', speaker: "Naoto", text: "Yosuke Hanamura. Unsupervised. In the real world. With civilians." },
            { type: 'dialogue', speaker: "Kanji", text: "Oh no." },
            { type: 'dialogue', speaker: "Naoto", text: "Oh yes.", anim: 'glitchNaoto' },
            
            { type: 'narration', text: "Rise closed her eyes. Her Scan activated—a faint golden ripple in the air.", effect: 'scanStart' },
            
            // GAME 3: TUNER
            { type: 'minigame_tuning', text: "TUNE INTO SENPAI" },

            { type: 'dialogue', speaker: "Rise", text: "I can feel them... they're at the Tea Bar. Senpai's doing great.", effect: 'scanActive' },
            { type: 'dialogue', speaker: "Rise", text: "Chie-senpai is excited about the Akihiko cosplayer. Yukiko-senpai is having fun." },
            { type: 'dialogue', speaker: "Teddie", text: "What about Yosuke?" },
            { type: 'dialogue', speaker: "Rise", text: "He just knocked over a display of keychains. He's scrambling." },
            { type: 'dialogue', speaker: "Kanji", text: "Classic.", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Rise", text: "Wait... there are other realities bleeding through. A Knight? A Proxy?", effect: 'scanActive' },
            { type: 'dialogue', speaker: "Naoto", text: "The cognitive space is hosting multiple narrative frameworks. Fascinating." },
            { type: 'dialogue', speaker: "Rise", text: "New Eridu gets to go? Life ain't fair, bear.", anim: 'sadRise' },
            { type: 'dialogue', speaker: "Rise", text: "Oh! Yosuke just tripped over nothing.", anim: 'bounceRise' },
            { type: 'dialogue', speaker: "Teddie", text: "YES! His suffering gives me life!", anim: 'spinTeddie' },
            { type: 'narration', text: "The four of them dissolved into laughter.", effect: 'scanEnd' },
            { type: 'dialogue', speaker: "Kanji", text: "Maybe being stuck here ain't so bad." },
            { type: 'dialogue', speaker: "Naoto", text: "We are the foundation. Everything Senpai does out there, he does with the strength we gave him." },
            { type: 'dialogue', speaker: "Rise", text: "Also, we get to watch Yosuke suffer without him knowing.", anim: 'bounceRise' },
            { type: 'dialogue', speaker: "Teddie", text: "Then let's throw the BEST void party ever! Ghost mode activate!", effect: 'ghostMode' },
            { type: 'dialogue', speaker: "Kanji", text: "To being cut content. Cheers to the void.", anim: 'shakeKanji' },
            { type: 'narration', text: "Somewhere, Yu Narukami felt a sudden warmth in his chest." },
            { type: 'narration', text: "Party in the void. Hell yeah." },
            { type: 'narration', text: "END OF TRANSMISSION.", effect: 'end' }
        ];

        // ==========================================
        // 2. ENGINE VARS
        // ==========================================
        let backCity = [], frontCity = [], clouds = [], skewers = [], confetti = [];
        let kanjiSteam = [];
        let timer = 0, score = 0, tuningTarget = 75;
        let isGhostMode = false;
        
        let signalPower = 0;
        let noiseOffset = 0;
        
        let charAnim = { kanjiShake: 0, riseBounce: 0, teddieRollX: -100, naotoGlitch: 0, teddieSpin: 0, riseGlow: false };
        let cPos = { k:0.15, n:0.40, r:0.65, t:0.85 };

        // ==========================================
        // 3. SPRITE MAPS
        // ==========================================
        const spriteScale = 4;
        const sprites = {
            kanji: [
                "  HHHH  ", " HHHHHH ", "HSSSSSSH", " SBBSSB ", " SSSSSS ",
                "CCCCCCCC", "C CACC C", "C CACC C", "CCCCCCCC", " L L  L L", " L L  L L"
            ],
            naoto: [
                "  CCCC  ", " CCCCCC ", "HSSSSSSH", " S B S B", " SSSSSS ",
                "JJJJJJJJ", "J YJJY J", "JJJJJJJJ", "J J  J J", "L L  L L"
            ],
            rise: [
                "H      H", "HH    HH", " HHHHHH ", "PHSSSSHP", "  YYYY  ", 
                " BBYYBB ", " BBBBBB ", " KKKKKK ", " KKKKKK ", " L L  L "
            ],
            teddie: [
                "   BB   ", " BBBBBB ", "BBWWWWBB", "B WBBW B", "BWWWWWWB",
                " BBBBBB ", " RRRRRR ", " RRRRRR ", " B B  B B", " B B  B B"
            ]
        };
        const colors = {
            'H': '#8B4513', 'S': '#FFDAB9', 'B': '#1a1a1a', 'C': '#000080', 
            'A': '#FFFFFF', 'L': '#050505', 'J': '#0000CD', 'Y': '#FFD700', 
            'P': '#FF69B4', 'K': '#A9A9A9', 'W': '#FFFFFF', 'R': '#DC143C'
        };

        // ==========================================
        // 4. P5.JS SETUP & DRAW
        // ==========================================
        function setup() {
            let cnv = createCanvas(windowWidth, windowHeight);
            cnv.parent('canvas-container');
            noSmooth(); 
            rectMode(CORNER);
            
            // Create Skyline Layers
            // Back layer: Darker, slower, taller
            for(let i=0; i<8; i++) {
                backCity.push(new DetailedBuilding(i * 200, 0.5, 'BACK'));
            }
            // Front layer: Lighter, faster, detailed windows
            for(let i=0; i<8; i++) {
                frontCity.push(new DetailedBuilding(i * 180, 1.5, 'FRONT'));
            }

            for(let i=0; i<5; i++) clouds.push(new Cloud());
            charAnim.teddieRollX = width * cPos.t;
        }

        function draw() {
            // TV World Yellow Background
            background(255, 235, 59);
            
            // 1. Far Background (Dark Silhouette)
            push(); translate(0, height/2 - 150);
            for(let b of backCity) { b.update(); b.show(); }
            pop();

            // 2. Fog Gradient
            setGradient(0, height/2 - 100, width, height/2 + 100, color(255,235,59, 100), color(255,235,59, 255));

            // 3. Midground (Detailed Buildings)
            push(); translate(0, height/2 - 50);
            for(let b of frontCity) { b.update(); b.show(); }
            pop();

            // 4. Floor
            drawFloor();

            // 5. Characters
            if (gameState !== 'END') drawCharacters();

            // 6. Minigames
            if(gameState === "SKEWER_GAME") playSkewerGame();
            else if(gameState === "SIGNAL_GAME") playSignalGame();
            else if(gameState === "TUNING_GAME") playTuningGame();

            // 7. Props
            for(let c of clouds) { c.update(); c.show(); }
            for(let c of confetti) { c.update(); c.show(); }
            
            // Steam
            if(gameState === 'STORY' && charAnim.kanjiShake > 0) {
                if(frameCount % 5 === 0) kanjiSteam.push(new Steam(width*cPos.k + 20, height/2 + 50));
            }
            for(let i=kanjiSteam.length-1; i>=0; i--) {
                kanjiSteam[i].update(); kanjiSteam[i].show();
                if(kanjiSteam[i].done) kanjiSteam.splice(i,1);
            }
        }

        function windowResized() { resizeCanvas(windowWidth, windowHeight); }

        // ==========================================
        // 5. CITY GENERATION CLASSES
        // ==========================================
        
        class DetailedBuilding {
            constructor(x, speed, layer) {
                this.x = x; 
                this.speed = speed; 
                this.layer = layer;
                this.generateShape();
            }

            generateShape() {
                this.w = random(80, 180);
                this.h = random(150, 400); // Taller buildings
                
                // Building Types
                let typeRand = random(1);
                this.type = 'NORMAL';
                if(typeRand < 0.3) this.type = 'SKYSCRAPER';
                else if(typeRand < 0.6) this.type = 'APARTMENT';
                else this.type = 'TOWER';

                // Colors
                if(this.layer === 'BACK') {
                    this.mainColor = color(30, 30, 30); // Dark grey silhouette
                    this.windowColor = color(60, 60, 60); // Dim windows
                } else {
                    this.mainColor = color(50, 50, 50); // Mid grey
                    this.windowColor = color(255, 255, 0, 150); // Yellow TV world windows
                }

                // Window Grid Generation
                this.windows = [];
                if(this.type === 'SKYSCRAPER') {
                    let rows = floor(this.h / 15);
                    let cols = floor(this.w / 12);
                    for(let r=2; r<rows-1; r++) {
                        for(let c=1; c<cols-1; c++) {
                            if(random() > 0.3) this.windows.push({x: c*12, y: r*15, w: 6, h: 8});
                        }
                    }
                } else if (this.type === 'APARTMENT') {
                    let rows = floor(this.h / 30);
                    let cols = floor(this.w / 40);
                    for(let r=1; r<rows; r++) {
                        for(let c=0; c<cols; c++) {
                            if(random() > 0.4) this.windows.push({x: c*40 + 10, y: r*30, w: 20, h: 15});
                        }
                    }
                }
                
                // Roof Features
                this.antenna = (random() > 0.5);
                this.antennaH = random(20, 50);
            }

            update() {
                this.x -= this.speed;
                if(this.x < -this.w - 50) {
                    this.x = width;
                    this.generateShape(); // New building when it wraps
                }
            }

            show() {
                fill(this.mainColor); noStroke();
                
                // Main Body
                rect(this.x, -this.h, this.w, this.h);
                
                // Roof Details
                if(this.type === 'SKYSCRAPER') {
                    rect(this.x + 10, -this.h - 20, this.w - 20, 20); // Top block
                } else if (this.type === 'TOWER') {
                    // Spire
                    rect(this.x + this.w/2 - 5, -this.h - 50, 10, 50);
                }

                if(this.antenna) {
                    stroke(this.mainColor); strokeWeight(2);
                    line(this.x + this.w/2, -this.h, this.x + this.w/2, -this.h - this.antennaH);
                    noStroke();
                }

                // Windows
                fill(this.windowColor);
                for(let win of this.windows) {
                    rect(this.x + win.x, -this.h + win.y, win.w, win.h);
                }
            }
        }

        // ==========================================
        // 6. CHARACTER & GAME FUNCTIONS
        // ==========================================
        
        function drawCharacters() {
            let baseY = height/2 + 50;
            if(isGhostMode) { tint(255, 100); } else { noTint(); }

            // Kanji
            push(); translate(width * cPos.k, baseY);
            if(charAnim.kanjiShake > 0) { translate(random(-2, 2), random(-2, 2)); charAnim.kanjiShake--; }
            drawPixSprite(sprites.kanji);
            pop();

            // Naoto
            push(); translate(width * cPos.n, baseY + 5);
            if(charAnim.naotoGlitch > 0) {
                if(frameCount % 4 < 2) translate(random(-5,5), 0);
                tint(random(255), 150); charAnim.naotoGlitch--;
            }
            drawPixSprite(sprites.naoto); 
            if(!isGhostMode) noTint();
            pop();

            // Rise
            push(); translate(width * cPos.r, baseY);
            if(charAnim.riseGlow) {
                noStroke(); fill(255, 215, 0, 100 + sin(frameCount*0.2)*50);
                ellipse(16, 20, 50 + sin(frameCount*0.2)*10, 50 + sin(frameCount*0.2)*10);
            }
            if(charAnim.riseBounce > 0) {
                translate(0, -abs(sin(frameCount * 0.2)) * 15); charAnim.riseBounce--;
            } else {
                translate(0, sin(frameCount * 0.05) * 3);
            }
            drawPixSprite(sprites.rise);
            pop();

            // Teddie
            push();
            if(charAnim.teddieSpin > 0) {
                translate(width * cPos.t + 16, baseY + 20);
                rotate(frameCount * 0.5);
                translate(-16, -20);
                charAnim.teddieSpin--;
            } else {
                 translate(width * cPos.t, baseY + 30 + sin(frameCount*0.1)*5);
                 if(charAnim.teddieShake > 0) { translate(random(-3,3), 0); charAnim.teddieShake--; }
            }
            drawPixSprite(sprites.teddie);
            pop();
            noTint();
        }

        function drawPixSprite(spriteMap, centered=false) {
            noStroke();
            let w = spriteMap[0].length * spriteScale;
            let h = spriteMap.length * spriteScale;
            if(centered) translate(-w/2, -h/2);
            for(let row=0; row<spriteMap.length; row++) {
                for(let col=0; col<spriteMap[row].length; col++) {
                    let char = spriteMap[row][col];
                    if(colors[char]) { fill(colors[char]); rect(col*spriteScale, row*spriteScale, spriteScale, spriteScale); }
                }
            }
        }

        // --- MINIGAMES ---

        // SKEWER GAME
        function startSkewerGame() {
            gameState = "SKEWER_GAME"; inputLocked = true;
            uiSet("TAP THE MEAT!");
            skewers = []; 
            for(let i=0; i<6; i++) skewers.push(new Skewer());
            timer = 300; score = 0;
        }
        function playSkewerGame() {
            drawTimerBar(timer, 300); timer--;
            for(let s of skewers) { s.update(); s.show(); }
            fill(0); textSize(20); textAlign(CENTER);
            text("CAPTURED: " + score + "/4", width/2, 80);
            if(score >= 4) { endGame(); }
            else if (timer <= 0) { timer = 200; skewers.push(new Skewer()); }
        }

        // SIGNAL BOOST GAME
        function startSignalGame() {
            gameState = "SIGNAL_GAME"; inputLocked = true;
            uiSet("RAPIDLY TAP TO BOOST!");
            signalPower = 30; timer = 0;
        }
        function playSignalGame() {
            if(frameCount % 2 == 0 && signalPower > 0) signalPower -= 1;
            
            let staticAlpha = map(signalPower, 0, 100, 200, 0);
            fill(20, 20, 20, staticAlpha); noStroke(); rect(0, 0, width, height);

            let barW = 200; let barH = 40;
            let bx = width/2 - barW/2; let by = height/2 - barH/2;
            
            fill(0); stroke(255); strokeWeight(3); rect(bx, by, barW, barH);
            let fillW = map(signalPower, 0, 100, 0, barW);
            if(fillW > barW) fillW = barW;
            noStroke();
            if(signalPower > 80) fill(0, 255, 0); else fill(255, 0, 50);
            rect(bx+3, by+3, fillW-6, barH-6);

            fill(255); textAlign(CENTER); textSize(20); noStroke();
            text("CONNECTION POWER", width/2, by - 15);
            text(floor(signalPower) + "%", width/2, by + barH + 25);
            if(signalPower >= 100) endGame();
        }
        function handleSignalTap() {
            if(gameState === "SIGNAL_GAME") {
                signalPower += 8; if(signalPower > 100) signalPower = 100;
                confetti.push(new Confetti(random(width), random(height)));
            }
        }

        // TUNER GAME
        function startTuningGame() {
            gameState = "TUNING_GAME"; inputLocked = true;
            uiSet("FIND FREQUENCY");
            document.getElementById('tuning-container').style.display = 'flex';
            tuningTarget = floor(random(25, 75)); timer = 0;
            document.getElementById('tuner').value = 0;
        }
        function playTuningGame() {
            let val = parseInt(document.getElementById('tuner').value);
            let diff = abs(val - tuningTarget);
            
            push(); translate(width/2, height/2 - 100); scale(4);
            noStroke(); 
            fill(210, 105, 30); rect(-5,-5, 10, 15);
            let alpha = map(diff, 0, 50, 0, 255);
            fill(random(50), alpha); rect(-20,-20,40,40);
            pop();

            let title = document.getElementById('game-title');
            if(diff < 5) { title.style.color = "#00FF00"; title.innerText = "LOCKED ON!"; timer++; } 
            else if (diff < 15) { title.style.color = "#FFFF00"; title.innerText = "CLOSE..."; timer = 0; } 
            else { title.style.color = "#FF0000"; title.innerText = "SEARCHING..."; timer = 0; }

            if(timer > 40) { document.getElementById('tuning-container').style.display = 'none'; endGame(); }
        }

        function uiSet(txt) {
            document.getElementById('minigame-ui').style.display = 'block';
            document.getElementById('game-title').innerText = txt;
            document.getElementById('game-title').style.color = '#FFE600';
            document.getElementById('arrow').style.display = 'none';
            document.getElementById('ui-layer').style.opacity = '0.2';
        }
        function endGame() {
            gameState = "STORY"; inputLocked = false;
            document.getElementById('minigame-ui').style.display = 'none';
            document.getElementById('arrow').style.display = 'block';
            document.getElementById('ui-layer').style.opacity = '1';
            skewers = []; advanceStory();
        }

        function drawTimerBar(t, maxT) {
            push(); rectMode(CORNER); noStroke();
            fill(0); rect(0, height-10, width, 10);
            fill(255, 0, 50); rect(0, height-10, map(t, 0, maxT, 0, width), 10);
            pop();
        }

        // INPUT
        function mousePressed() { handleSkewerTap(mouseX, mouseY); handleSignalTap(); }
        function touchStarted() { 
            if(touches.length > 0) { handleSkewerTap(touches[0].x, touches[0].y); handleSignalTap(); }
            return false; 
        }
        function handleSkewerTap(x, y) {
            if(gameState === "SKEWER_GAME") {
                for(let i = skewers.length-1; i>=0; i--) {
                    if(dist(x, y, skewers[i].pos.x, skewers[i].pos.y) < 80) {
                        skewers.splice(i, 1); score++; 
                        for(let k=0; k<10; k++) confetti.push(new Confetti(x, y));
                    }
                }
            }
        }
        let currentIndex = -1;
        function handleInput() { if(inputLocked || gameState === 'END') return; advanceStory(); }

        function advanceStory() {
            currentIndex++;
            if(currentIndex >= story.length) return;
            const s = story[currentIndex];
            
            if(s.type === 'minigame_skewer') { startSkewerGame(); return; }
            if(s.type === 'minigame_signal') { startSignalGame(); return; }
            if(s.type === 'minigame_tuning') { startTuningGame(); return; }

            document.getElementById('typing-text').innerHTML = s.text;
            
            if(s.effect === 'kanjiSteam') charAnim.kanjiShake = 60;
            if(s.effect === 'teddieCrash') { 
                charAnim.teddieRollX = -50; 
                let crashInt = setInterval(() => {
                   charAnim.teddieRollX += 20;
                   if(charAnim.teddieRollX > width * 0.7) { clearInterval(crashInt); charAnim.teddieRollX = width * cPos.t; }
                }, 16);
            }
            if(s.effect === 'scanStart') charAnim.riseGlow = true;
            if(s.effect === 'scanEnd') charAnim.riseGlow = false;
            if(s.effect === 'ghostMode') isGhostMode = true;
            if(s.effect === 'end') { gameState = 'END'; document.getElementById('canvas-container').style.opacity = "0.2"; document.getElementById('speaker').style.display = 'none'; }

            if(s.anim === 'shakeKanji') charAnim.kanjiShake = 40;
            if(s.anim === 'glitchNaoto') charAnim.naotoGlitch = 60;
            if(s.anim === 'bounceRise') charAnim.riseBounce = 60;
            if(s.anim === 'spinTeddie') charAnim.teddieSpin = 60;
            if(s.anim === 'shakeTeddie') charAnim.teddieShake = 60;

            const spk = document.getElementById('speaker');
            if(s.speaker) {
                spk.style.display = 'block'; spk.innerText = s.speaker;
                spk.style.backgroundColor = (s.speaker==='Kanji'?'#ff5252': s.speaker==='Naoto'?'#448aff': s.speaker==='Rise'?'#ff4081': s.speaker==='Teddie'?'#03A9F4':'#fff');
            } else { spk.style.display = 'none'; }
        }

        // UTILS
        class Steam {
            constructor(x,y) { this.x=x; this.y=y; this.life=255; }
            update() { this.y-=3; this.x+=random(-1,1); this.life-=8; }
            show() { fill(255, this.life); noStroke(); rect(this.x, this.y, 8, 8); }
            get done() { return this.life < 0; }
        }
        class Skewer {
            constructor() { 
                this.pos = createVector(random(50, width-50), random(50, height-200)); 
                this.vel = createVector(random(-12,12), random(-12,12)); 
            }
            update() { 
                this.pos.add(this.vel); 
                if(this.pos.x<20||this.pos.x>width-20)this.vel.x*=-1; 
                if(this.pos.y<20||this.pos.y>height-200)this.vel.y*=-1; 
            }
            show() { 
                push(); translate(this.pos.x, this.pos.y); rotate(frameCount*0.4); 
                fill(139,69,19); rect(-15,-5,30,10); fill(222,184,135); rect(-20,-1,35,2); pop(); 
            }
        }
        class Cloud { 
            constructor(){this.reset();} 
            reset(){this.x=random(width); this.y=random(height*0.3); this.speed=random(0.5, 1.5);} 
            update(){this.x+=this.speed; if(this.x>width+100)this.x=-100; if(frameCount%900==0)this.reset();} 
            show(){noStroke(); fill(255,180); rect(this.x,this.y,100,40,20);}
        }
        class Confetti { 
            constructor(x,y){this.x=x;this.y=y;this.c=color(random(255),random(255),0); this.vy = random(-5, -2); this.vx = random(-2,2);} 
            update(){this.y+=3; this.x+=this.vx; this.y-=this.vy; this.vy+=0.1;} 
            show(){fill(this.c);noStroke();rect(this.x,this.y,6,6);}
        }
        function drawFloor() { noStroke(); let horizon=height/2+50; for(let y=horizon;y<height;y+=25){for(let x=0;x<width;x+=50){fill((x+y)%100===0?40:60); let p=map(y,horizon,height,0.5,1.5); rect(x,y,50*p,25);}}}
        function setGradient(x,y,w,h,c1,c2){ noFill(); for(let i=y;i<=y+h;i++){ let inter=map(i,y,y+h,0,1); stroke(lerpColor(c1,c2,inter)); line(x,i,x+w,i);}}
    </script>
</body>
</html>