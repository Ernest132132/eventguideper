<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>BUFFERING AT THE FOOD COURT: GOLDEN</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            background-color: #111;
            font-family: 'VT323', monospace;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        #canvas-container { position: fixed; top: 0; left: 0; z-index: 1; }

        /* CRT SCANLINE EFFECT */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            z-index: 99; pointer-events: none;
            mix-blend-mode: overlay;
            opacity: 0.6;
        }

        /* UI CONTAINER */
        #ui-layer {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 600px; z-index: 100;
            display: flex; flex-direction: column;
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.8));
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .speaker-box {
            background: #FFE600; color: #111;
            padding: 5px 20px; font-size: clamp(1rem, 4vw, 1.5rem); font-weight: bold;
            width: fit-content; border: 3px solid #fff;
            transform: skew(-15deg) translateX(10px);
            margin-bottom: -5px; z-index: 102; display: none;
        }

        .text-box {
            background: rgba(0, 0, 0, 0.9); border: 3px solid #FFE600;
            padding: 15px; color: #fff; font-size: clamp(1rem, 3.5vw, 1.4rem); line-height: 1.4;
            min-height: clamp(80px, 15vh, 120px);
            clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
            pointer-events: auto;
            position: relative;
        }

        .tap-indicator {
            position: absolute; bottom: 10px; right: 15px; color: #FFE600;
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            animation: blink 0.8s infinite;
        }
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

        /* MINI GAME UI OVERLAYS */
        #minigame-ui {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; text-align: center; z-index: 110; display: none;
            pointer-events: none;
        }
        .game-instruction {
            font-size: clamp(1.8rem, 8vw, 3.5rem);
            color: #FFE600;
            text-shadow: 3px 3px #000;
            font-weight: bold;
            line-height: 1.1;
            animation: pop 0.5s infinite alternate;
            word-wrap: break-word;
        }
        @keyframes pop { from { transform: scale(1) rotate(-2deg); } to { transform: scale(1.1) rotate(2deg); } }

        /* RAGE METER UI */
        #rage-meter-container {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 110;
        }
        #rage-bar-bg {
            width: 100%;
            height: clamp(30px, 6vh, 50px);
            background: #000;
            border: 3px solid #FFE600;
            position: relative;
            overflow: hidden;
        }
        #rage-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #FFE600, #ff5252);
            transition: width 0.1s, background 0.2s;
        }
        #rage-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(1rem, 4vw, 1.5rem);
            color: #fff;
            font-weight: bold;
            text-shadow: 2px 2px #000;
            z-index: 111;
        }

        /* YOSUKE BETTING UI */
        #betting-container {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            z-index: 110;
            pointer-events: auto;
        }
        .bet-button {
            background: #FFE600;
            color: #000;
            border: 4px solid #fff;
            font-family: 'VT323', monospace;
            font-size: clamp(1.2rem, 5vw, 2rem);
            padding: clamp(15px, 3vh, 25px);
            margin: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            width: calc(100% - 20px);
            touch-action: manipulation;
        }
        .bet-button:active {
            transform: scale(0.95);
            background: #fff;
        }
        #bet-result {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            color: #FFE600;
            text-shadow: 3px 3px #000;
            margin-top: 20px;
            font-weight: bold;
        }

        /* GHOST MODE CONTROLS */
        #ghost-controls {
            display: none;
            position: fixed;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 110;
            text-align: center;
        }
        .ghost-instruction {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            color: #fff;
            text-shadow: 3px 3px #000;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border: 3px solid #FFE600;
        }
        #arrow-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .arrow-btn {
            background: rgba(255, 230, 0, 0.8);
            border: 3px solid #fff;
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            cursor: pointer;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .arrow-btn:active {
            background: #fff;
        }

        /* ENDING BUTTON */
        #cleanup-btn {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFE600;
            color: #000;
            border: 5px solid #fff;
            font-family: 'VT323', monospace;
            font-size: clamp(2rem, 8vw, 4rem);
            padding: clamp(20px, 4vh, 40px) clamp(40px, 8vw, 80px);
            cursor: pointer;
            font-weight: bold;
            z-index: 120;
            animation: pulse 1s infinite;
            touch-action: manipulation;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        #version-tag {
            position: fixed; top: 5px; right: 5px; color: rgba(0,0,0,0.4); z-index: 200; font-size: 10px;
        }
    </style>
</head>
<body>

    <div id="version-tag">v6.0 - COMEDY REWRITE</div>
    <div class="scanlines"></div>
    <div id="canvas-container"></div>

    <!-- RAGE METER -->
    <div id="rage-meter-container">
        <div id="rage-bar-bg">
            <div id="rage-bar-fill"></div>
        </div>
        <div id="rage-label">KANJI'S RAGE: 0%</div>
    </div>

    <!-- BETTING UI -->
    <div id="betting-container">
        <div id="game-title" class="game-instruction">WHAT WILL HAPPEN?</div>
        <button class="bet-button" id="bet-fall">He trips over nothing</button>
        <button class="bet-button" id="bet-spill">He spills something</button>
        <button class="bet-button" id="bet-break">He breaks something</button>
        <div id="bet-result"></div>
    </div>

    <!-- GHOST MODE CONTROLS -->
    <div id="ghost-controls">
        <div class="ghost-instruction">USE ARROWS TO EXPLORE</div>
        <div id="arrow-controls">
            <div class="arrow-btn" id="arrow-up">▲</div>
            <div style="width: 100%; display: flex; justify-content: center; gap: 10px;">
                <div class="arrow-btn" id="arrow-left">◄</div>
                <div class="arrow-btn" id="arrow-down">▼</div>
                <div class="arrow-btn" id="arrow-right">►</div>
            </div>
        </div>
    </div>

    <!-- CLEANUP BUTTON -->
    <button id="cleanup-btn">CLEAR MEMORY</button>

    <div id="minigame-ui">
        <div id="game-title" class="game-instruction">GAME START!</div>
    </div>

    <div id="ui-layer">
        <div id="speaker" class="speaker-box">SPEAKER</div>
        <div id="dialogue" class="text-box" onclick="handleInput()">
            <span id="typing-text">BUFFERING AT THE FOOD COURT<br>[TAP TO START]</span>
            <div class="tap-indicator" id="arrow">▼</div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. STORY & CONFIGURATION
        // ==========================================
        let gameState = "STORY";
        let inputLocked = false;

        const story = [
            { type: 'narration', text: "The Junes Food Court was perfect. Too perfect." },
            { type: 'narration', text: "The sky was stuck on 'Sunny Afternoon,' scrolling and snapping back every 12 seconds." },
            { type: 'narration', text: "The tables were shiny, and the steak skewers on Kanji Tatsumi's plate had been steaming for three hours.", effect: 'kanjiSteam' },
            { type: 'narration', text: "Also, he couldn't pick them up." },
            { type: 'dialogue', speaker: "Kanji", text: "This is bull. I can see 'em. I can smell 'em. Why can't I—", anim: 'shakeKanji' },

            // ACT I: KANJI RAGE METER
            { type: 'minigame_rage', text: "TAP TO HELP KANJI GRAB THE MEAT!" },

            { type: 'dialogue', speaker: "Naoto", text: "Fascinating. Your rage levels directly correlate with reality distortion.", anim: 'glitchNaoto' },
            { type: 'dialogue', speaker: "Kanji", text: "English, Pint-Size!", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Naoto", text: "We're stuck in the TV World because everyone's thinking about Senpai right now, not us." },
            { type: 'dialogue', speaker: "Kanji", text: "Oh. So we're like... background characters." },
            { type: 'dialogue', speaker: "Rise", text: "Cut content. We didn't make the guest list.", anim: 'sadRise' },
            { type: 'dialogue', speaker: "Kanji", text: "I bet Yosuke begged to go. 'Please, let me be useful, I promise I won't crash!'" },
            { type: 'dialogue', speaker: "Naoto", text: "To be fair, statistically, Yosuke crashes in seventy percent of our investigations." },
            { type: 'dialogue', speaker: "Rise", text: "Seventy? I thought it was higher.", anim: 'bounceRise' },

            // ACT II: TEDDIE BOUNCE
            { type: 'narration', text: "Before anyone could respond, a blue-and-white blur shot toward them from above!" },
            { type: 'minigame_teddie', text: "CATCH TEDDIE BEFORE HE CRASHES!" },

            { type: 'dialogue', speaker: "Teddie", text: "Thanks for the catch! The signal's jammed! There's a barrier!", anim: 'shakeTeddie' },
            { type: 'dialogue', speaker: "Teddie", text: "A wall of pure indifference! The humans aren't thinking about us!", anim: 'spinTeddie' },
            { type: 'dialogue', speaker: "Naoto", text: "They're too busy with their event." },
            { type: 'dialogue', speaker: "Teddie", text: "Do you know what this means?! We're nobodies! We're—" },
            { type: 'dialogue', speaker: "Naoto", text: "Backup files." },
            { type: 'dialogue', speaker: "Teddie", text: "I WAS GOING TO SAY TRAGIC GHOSTS!" },
            { type: 'dialogue', speaker: "Rise", text: "We're not ghosts, Teddie. We're just... on standby." },
            { type: 'dialogue', speaker: "Kanji", text: "So what, we just sit here? While Senpai gets to hang out in the real world?", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Rise", text: "With boba." },
            { type: 'dialogue', speaker: "Kanji", text: "And working chopsticks.", anim: 'shakeKanji' },
            { type: 'narration', text: "A beat of depressed silence." },
            { type: 'dialogue', speaker: "Naoto", text: "Actually, this is an excellent opportunity.", anim: 'nodNaoto' },
            { type: 'dialogue', speaker: "Naoto", text: "Yosuke Hanamura. Unsupervised. In the real world. With civilians." },
            { type: 'dialogue', speaker: "Kanji", text: "Oh no." },
            { type: 'dialogue', speaker: "Naoto", text: "Oh yes.", anim: 'glitchNaoto' },

            { type: 'narration', text: "Rise closed her eyes. Her Scan activated—a faint golden ripple in the air.", effect: 'scanStart' },
            { type: 'dialogue', speaker: "Rise", text: "I can feel them... they're at the Tea Bar. Senpai's doing great.", effect: 'scanActive' },
            { type: 'dialogue', speaker: "Rise", text: "Chie-senpai is excited. Yukiko-senpai is having fun." },
            { type: 'dialogue', speaker: "Teddie", text: "What about Yosuke? What's he doing?" },

            // ACT III: YOSUKE PREDICTIONS
            { type: 'minigame_betting', text: "PREDICT YOSUKE'S NEXT MISTAKE!" },

            { type: 'dialogue', speaker: "Rise", text: "There are other realities bleeding through. A Knight? A Proxy?", effect: 'scanActive' },
            { type: 'dialogue', speaker: "Naoto", text: "The cognitive space is hosting multiple narrative frameworks. Fascinating." },
            { type: 'dialogue', speaker: "Rise", text: "Wait... he's at it again!" },

            { type: 'minigame_betting', text: "PREDICT YOSUKE'S NEXT MISTAKE!" },

            { type: 'dialogue', speaker: "Teddie", text: "YES! His suffering gives me life!", anim: 'spinTeddie' },
            { type: 'dialogue', speaker: "Kanji", text: "Are we... are we cursing him?", anim: 'shakeKanji' },
            { type: 'narration', text: "The four of them looked at each other." },
            { type: 'dialogue', speaker: "Rise", text: "No, no. He's just naturally like this." },
            { type: 'dialogue', speaker: "Naoto", text: "Statistically proven." },
            { type: 'dialogue', speaker: "Teddie", text: "It's science!", anim: 'bounceRise' },
            { type: 'dialogue', speaker: "Rise", text: "One more prediction..." },

            { type: 'minigame_betting', text: "FINAL PREDICTION!" },

            { type: 'narration', text: "The four of them dissolved into laughter.", effect: 'scanEnd' },
            { type: 'dialogue', speaker: "Kanji", text: "Maybe being stuck here ain't so bad." },
            { type: 'dialogue', speaker: "Naoto", text: "We are the foundation. Everything Senpai does, he does with our strength." },
            { type: 'dialogue', speaker: "Rise", text: "Also, we get to watch Yosuke suffer without him knowing.", anim: 'bounceRise' },
            { type: 'dialogue', speaker: "Teddie", text: "Then let's throw the BEST void party ever! Ghost mode activate!", effect: 'ghostModeStart' },

            // ACT IV: GHOST MODE
            { type: 'minigame_ghost', text: "EXPLORE AS GHOSTS!" },

            { type: 'dialogue', speaker: "Kanji", text: "Whoa. I can walk through walls now.", anim: 'shakeKanji' },
            { type: 'dialogue', speaker: "Rise", text: "We're like... guardian angels. Watching over Senpai.", anim: 'bounceRise' },
            { type: 'dialogue', speaker: "Naoto", text: "More accurately, we're persistent cognitive constructs in his psyche." },
            { type: 'dialogue', speaker: "Teddie", text: "I PREFER GHOST PARTY!" },
            { type: 'dialogue', speaker: "Kanji", text: "To being cut content. Cheers to the void.", anim: 'shakeKanji' },
            { type: 'narration', text: "Somewhere, Yu Narukami felt a sudden warmth in his chest." },
            { type: 'narration', text: "His bonds were always with him, even in the space between memories." },
            { type: 'dialogue', speaker: "Rise", text: "He feels us. I can sense it.", effect: 'scanActive' },
            { type: 'dialogue', speaker: "Naoto", text: "The connection persists, even across narrative boundaries." },
            { type: 'narration', text: "Party in the void. Hell yeah." },
            { type: 'narration', text: "END OF TRANSMISSION.", effect: 'ending' }
        ];

        // ==========================================
        // 2. ENGINE VARS
        // ==========================================
        let backCity = [], frontCity = [], clouds = [], confetti = [];
        let kanjiSteam = [];
        let timer = 0, score = 0;
        let isGhostMode = false;
        let ghostPos = {x: 0, y: 0};
        let ghostTrail = [];

        // Rage meter
        let rageMeter = 0;
        let rageDecay = 0.5;
        let screenShake = 0;
        let glitchEffect = 0;

        // Teddie bounce
        let teddieY = -100;
        let teddieVel = 0;
        let teddieBounces = 0;
        let teddieX = 0;

        // Betting game
        let betOptions = [
            {text: "He trips over nothing", anim: "trip"},
            {text: "He spills something", anim: "spill"},
            {text: "He breaks something", anim: "break"}
        ];
        let currentBetIndex = 0;
        let betLocked = false;

        let charAnim = { kanjiShake: 0, riseBounce: 0, naotoGlitch: 0, teddieSpin: 0, teddieShake: 0, riseGlow: false };
        let cPos = { k:0.15, n:0.40, r:0.65, t:0.85 };

        // ==========================================
        // 3. SPRITE MAPS
        // ==========================================
        let spriteScale = 4;
        const sprites = {
            kanji: [
                "  HHHH  ", " HHHHHH ", "HSSSSSSH", " SBBSSB ", " SSSSSS ",
                "CCCCCCCC", "C CACC C", "C CACC C", "CCCCCCCC", " L L  L L", " L L  L L"
            ],
            naoto: [
                "  CCCC  ", " CCCCCC ", "HSSSSSSH", " S B S B", " SSSSSS ",
                "JJJJJJJJ", "J YJJY J", "JJJJJJJJ", "J J  J J", "L L  L L"
            ],
            rise: [
                "H      H", "HH    HH", " HHHHHH ", "PHSSSSHP", "  YYYY  ",
                " BBYYBB ", " BBBBBB ", " KKKKKK ", " KKKKKK ", " L L  L "
            ],
            teddie: [
                "   BB   ", " BBBBBB ", "BBWWWWBB", "B WBBW B", "BWWWWWWB",
                " BBBBBB ", " RRRRRR ", " RRRRRR ", " B B  B B", " B B  B B"
            ]
        };
        const colors = {
            'H': '#8B4513', 'S': '#FFDAB9', 'B': '#1a1a1a', 'C': '#000080',
            'A': '#FFFFFF', 'L': '#050505', 'J': '#0000CD', 'Y': '#FFD700',
            'P': '#FF69B4', 'K': '#A9A9A9', 'W': '#FFFFFF', 'R': '#DC143C'
        };

        // ==========================================
        // 4. P5.JS SETUP & DRAW
        // ==========================================
        function setup() {
            let w = window.innerWidth;
            let h = window.innerHeight;

            let cnv = createCanvas(w, h);
            cnv.parent('canvas-container');
            noSmooth();
            rectMode(CORNER);

            // Adjust sprite scale
            if(w < 400) spriteScale = 2.5;
            else if(w < 600) spriteScale = 3;
            else if(w < 800) spriteScale = 3.5;
            else spriteScale = 4;

            let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if(isMobile) frameRate(30);

            // Create city layers with fewer buildings on mobile
            let buildingCount = isMobile ? 5 : 8;
            for(let i=0; i<buildingCount; i++) {
                backCity.push(new DetailedBuilding(i * 200, 0.5, 'BACK'));
            }
            for(let i=0; i<buildingCount; i++) {
                frontCity.push(new DetailedBuilding(i * 180, 1.5, 'FRONT'));
            }

            for(let i=0; i<5; i++) clouds.push(new Cloud());

            ghostPos.x = width / 2;
            ghostPos.y = height / 2;
        }

        function draw() {
            // NOON CITY SKYVIEW BACKGROUND
            // Sky gradient - light blue to deeper blue
            setGradient(0, 0, width, height/2, color(135, 206, 250), color(70, 130, 180));

            // Sun
            drawSun();

            // Clouds in sky
            for(let c of clouds) { c.update(); c.show(); }

            // Screen shake from rage
            if(screenShake > 0) {
                translate(random(-screenShake, screenShake), random(-screenShake, screenShake));
                screenShake *= 0.9;
            }

            // Glitch effect
            if(glitchEffect > 0) {
                drawGlitch();
                glitchEffect--;
            }

            // 1. Far Background (Dark Silhouette)
            push(); translate(0, height/2 - 150);
            for(let b of backCity) { b.update(); b.show(); }
            pop();

            // 2. Midground (Detailed Buildings)
            push(); translate(0, height/2 - 50);
            for(let b of frontCity) { b.update(); b.show(); }
            pop();

            // 3. Floor
            drawFloor();

            // 4. Characters
            if (gameState !== 'END') drawCharacters();

            // 5. Minigames
            if(gameState === "RAGE_GAME") playRageGame();
            else if(gameState === "TEDDIE_GAME") playTeddieGame();
            else if(gameState === "GHOST_GAME") playGhostGame();

            // 6. Props
            for(let c of confetti) { c.update(); c.show(); }

            // Steam
            if(charAnim.kanjiShake > 0) {
                if(frameCount % 5 === 0) kanjiSteam.push(new Steam(width*cPos.k + 20, height/2 + 50));
            }
            for(let i=kanjiSteam.length-1; i>=0; i--) {
                kanjiSteam[i].update(); kanjiSteam[i].show();
                if(kanjiSteam[i].done) kanjiSteam.splice(i,1);
            }

            // Ghost trail
            if(gameState === "GHOST_GAME") {
                for(let i=ghostTrail.length-1; i>=0; i--) {
                    let t = ghostTrail[i];
                    fill(255, 255, 255, t.alpha);
                    noStroke();
                    ellipse(t.x, t.y, 20, 20);
                    t.alpha -= 5;
                    if(t.alpha <= 0) ghostTrail.splice(i, 1);
                }

                // Ghost player
                fill(255, 255, 255, 150);
                noStroke();
                ellipse(ghostPos.x, ghostPos.y, 40, 40);
                fill(255);
                ellipse(ghostPos.x - 8, ghostPos.y - 5, 8, 8);
                ellipse(ghostPos.x + 8, ghostPos.y - 5, 8, 8);
            }
        }

        function drawSun() {
            // Sun position (top right area)
            let sunX = width * 0.75;
            let sunY = height * 0.15;

            // Glow
            for(let i=80; i>0; i-=10) {
                fill(255, 255, 150, 20);
                noStroke();
                ellipse(sunX, sunY, i*2, i*2);
            }

            // Sun
            fill(255, 255, 100);
            ellipse(sunX, sunY, 60, 60);
        }

        function drawGlitch() {
            for(let i=0; i<5; i++) {
                let y = random(height);
                let h = random(10, 50);
                fill(255, 0, 0, 50);
                noStroke();
                rect(0, y, width, h);
            }
        }

        function windowResized() {
            let w = window.innerWidth;
            let h = window.innerHeight;
            resizeCanvas(w, h);

            if(w < 400) spriteScale = 2.5;
            else if(w < 600) spriteScale = 3;
            else if(w < 800) spriteScale = 3.5;
            else spriteScale = 4;
        }

        // ==========================================
        // 5. CITY GENERATION CLASSES
        // ==========================================

        class DetailedBuilding {
            constructor(x, speed, layer) {
                this.x = x;
                this.speed = speed;
                this.layer = layer;
                this.generateShape();
            }

            generateShape() {
                this.w = random(80, 180);
                this.h = random(150, 400);

                let typeRand = random(1);
                this.type = 'NORMAL';
                if(typeRand < 0.3) this.type = 'SKYSCRAPER';
                else if(typeRand < 0.6) this.type = 'APARTMENT';
                else this.type = 'TOWER';

                // BRIGHTER COLORS FOR NOON
                if(this.layer === 'BACK') {
                    this.mainColor = color(100, 120, 140); // Light grey-blue
                    this.windowColor = color(150, 170, 190); // Lighter windows
                } else {
                    this.mainColor = color(180, 200, 220); // Very light grey-blue
                    this.windowColor = color(255, 255, 150, 200); // Bright yellow windows
                }

                // Window Grid
                this.windows = [];
                if(this.type === 'SKYSCRAPER') {
                    let rows = floor(this.h / 15);
                    let cols = floor(this.w / 12);
                    for(let r=2; r<rows-1; r++) {
                        for(let c=1; c<cols-1; c++) {
                            if(random() > 0.3) this.windows.push({x: c*12, y: r*15, w: 6, h: 8});
                        }
                    }
                } else if (this.type === 'APARTMENT') {
                    let rows = floor(this.h / 30);
                    let cols = floor(this.w / 40);
                    for(let r=1; r<rows; r++) {
                        for(let c=0; c<cols; c++) {
                            if(random() > 0.4) this.windows.push({x: c*40 + 10, y: r*30, w: 20, h: 15});
                        }
                    }
                }

                this.antenna = (random() > 0.5);
                this.antennaH = random(20, 50);
            }

            update() {
                this.x -= this.speed;
                if(this.x < -this.w - 50) {
                    this.x = width;
                    this.generateShape();
                }
            }

            show() {
                fill(this.mainColor); noStroke();
                rect(this.x, -this.h, this.w, this.h);

                if(this.type === 'SKYSCRAPER') {
                    rect(this.x + 10, -this.h - 20, this.w - 20, 20);
                } else if (this.type === 'TOWER') {
                    rect(this.x + this.w/2 - 5, -this.h - 50, 10, 50);
                }

                if(this.antenna) {
                    stroke(this.mainColor); strokeWeight(2);
                    line(this.x + this.w/2, -this.h, this.x + this.w/2, -this.h - this.antennaH);
                    noStroke();
                }

                fill(this.windowColor);
                for(let win of this.windows) {
                    rect(this.x + win.x, -this.h + win.y, win.w, win.h);
                }
            }
        }

        // ==========================================
        // 6. CHARACTER & GAME FUNCTIONS
        // ==========================================

        function drawCharacters() {
            let baseY = height/2 + 50;
            if(isGhostMode) { tint(255, 100); } else { noTint(); }

            // Kanji
            push(); translate(width * cPos.k, baseY);
            if(charAnim.kanjiShake > 0) { translate(random(-2, 2), random(-2, 2)); charAnim.kanjiShake--; }
            drawPixSprite(sprites.kanji);
            pop();

            // Naoto
            push(); translate(width * cPos.n, baseY + 5);
            if(charAnim.naotoGlitch > 0) {
                if(frameCount % 4 < 2) translate(random(-5,5), 0);
                tint(random(255), 150); charAnim.naotoGlitch--;
            }
            drawPixSprite(sprites.naoto);
            if(!isGhostMode) noTint();
            pop();

            // Rise
            push(); translate(width * cPos.r, baseY);
            if(charAnim.riseGlow) {
                noStroke(); fill(255, 215, 0, 100 + sin(frameCount*0.2)*50);
                ellipse(16, 20, 50 + sin(frameCount*0.2)*10, 50 + sin(frameCount*0.2)*10);
            }
            if(charAnim.riseBounce > 0) {
                translate(0, -abs(sin(frameCount * 0.2)) * 15); charAnim.riseBounce--;
            } else {
                translate(0, sin(frameCount * 0.05) * 3);
            }
            drawPixSprite(sprites.rise);
            pop();

            // Teddie (only if not in teddie game)
            if(gameState !== "TEDDIE_GAME") {
                push();
                if(charAnim.teddieSpin > 0) {
                    translate(width * cPos.t + 16, baseY + 20);
                    rotate(frameCount * 0.5);
                    translate(-16, -20);
                    charAnim.teddieSpin--;
                } else {
                    translate(width * cPos.t, baseY + 30 + sin(frameCount*0.1)*5);
                    if(charAnim.teddieShake > 0) { translate(random(-3,3), 0); charAnim.teddieShake--; }
                }
                drawPixSprite(sprites.teddie);
                pop();
            }
            noTint();
        }

        function drawPixSprite(spriteMap, centered=false) {
            noStroke();
            let w = spriteMap[0].length * spriteScale;
            let h = spriteMap.length * spriteScale;
            if(centered) translate(-w/2, -h/2);
            for(let row=0; row<spriteMap.length; row++) {
                for(let col=0; col<spriteMap[row].length; col++) {
                    let char = spriteMap[row][col];
                    if(colors[char]) { fill(colors[char]); rect(col*spriteScale, row*spriteScale, spriteScale, spriteScale); }
                }
            }
        }

        // --- MINIGAMES ---

        // RAGE METER GAME
        function startRageGame() {
            gameState = "RAGE_GAME"; inputLocked = true;
            uiSet("TAP TO HELP KANJI!");
            document.getElementById('rage-meter-container').style.display = 'block';
            rageMeter = 0;
            timer = 0;
        }

        function playRageGame() {
            // Decay rage meter
            if(frameCount % 3 === 0 && rageMeter > 0) {
                rageMeter -= rageDecay;
                if(rageMeter < 0) rageMeter = 0;
            }

            // Update UI
            let rageBar = document.getElementById('rage-bar-fill');
            let rageLabel = document.getElementById('rage-label');
            rageBar.style.width = rageMeter + '%';
            rageLabel.innerText = 'KANJI\'S RAGE: ' + Math.floor(rageMeter) + '%';

            // Visual effects based on rage
            if(rageMeter > 80) {
                rageBar.style.background = 'linear-gradient(90deg, #ff0000, #ff5252)';
                screenShake = 5;
                glitchEffect = 3;
                charAnim.kanjiShake = 10;

                // Spawn confetti
                if(frameCount % 5 === 0) {
                    confetti.push(new Confetti(random(width), random(height/2, height)));
                }
            } else if(rageMeter > 50) {
                rageBar.style.background = 'linear-gradient(90deg, #ff5252, #FFE600)';
                if(frameCount % 10 === 0) screenShake = 2;
            } else {
                rageBar.style.background = 'linear-gradient(90deg, #FFE600, #fff)';
            }

            // Win condition
            timer++;
            if(rageMeter >= 100 || timer > 300) {
                document.getElementById('rage-meter-container').style.display = 'none';
                endGame();
            }
        }

        function handleRageTap() {
            if(gameState === "RAGE_GAME") {
                rageMeter += 8;
                if(rageMeter > 100) rageMeter = 100;
                charAnim.kanjiShake = 10;
            }
        }

        // TEDDIE BOUNCE GAME
        function startTeddieGame() {
            gameState = "TEDDIE_GAME"; inputLocked = true;
            uiSet("CATCH TEDDIE!");
            teddieY = -100;
            teddieVel = 2;
            teddieBounces = 0;
            teddieX = random(width * 0.2, width * 0.8);
        }

        function playTeddieGame() {
            // Teddie physics
            teddieVel += 0.5; // Gravity
            teddieY += teddieVel;

            // Draw falling Teddie
            push();
            translate(teddieX, teddieY);
            rotate(frameCount * 0.3);
            drawPixSprite(sprites.teddie, true);
            pop();

            // Check if caught by player tap
            // If not caught and hits bottom, bounce back up
            if(teddieY > height - 100 && teddieVel > 0) {
                teddieVel = -15;
                teddieBounces++;
                screenShake = 3;

                // Spawn impact effect
                for(let i=0; i<10; i++) {
                    confetti.push(new Confetti(teddieX, height - 100));
                }

                if(teddieBounces >= 3) {
                    // Caught after bounces
                    endGame();
                }
            }
        }

        function handleTeddieTap(x, y) {
            if(gameState === "TEDDIE_GAME") {
                let hitRadius = 100;
                if(dist(x, y, teddieX, teddieY) < hitRadius) {
                    // Successfully caught!
                    for(let i=0; i<20; i++) {
                        confetti.push(new Confetti(teddieX, teddieY));
                    }
                    endGame();
                }
            }
        }

        // BETTING GAME
        function startBettingGame() {
            gameState = "BETTING_GAME"; inputLocked = true;
            document.getElementById('betting-container').style.display = 'block';
            document.getElementById('ui-layer').style.opacity = '0.2';
            document.getElementById('minigame-ui').style.display = 'none';

            // Randomize correct answer
            currentBetIndex = floor(random(3));
            betLocked = false;
            document.getElementById('bet-result').innerText = '';
            document.getElementById('bet-result').style.color = '#FFE600';
        }

        function handleBet(index) {
            if(betLocked) return;
            betLocked = true;

            let resultDiv = document.getElementById('bet-result');

            if(index === currentBetIndex) {
                resultDiv.innerText = '✓ YOU CALLED IT!';
                resultDiv.style.color = '#00FF00';

                // Celebration
                for(let i=0; i<30; i++) {
                    confetti.push(new Confetti(random(width), random(height)));
                }
                charAnim.riseBounce = 60;
            } else {
                resultDiv.innerText = '✗ CLOSE, BUT...';
                resultDiv.style.color = '#ff5252';
            }

            // Continue after delay
            setTimeout(() => {
                document.getElementById('betting-container').style.display = 'none';
                document.getElementById('ui-layer').style.opacity = '1';
                endGame();
            }, 2000);
        }

        // GHOST MODE GAME
        function startGhostGame() {
            gameState = "GHOST_GAME"; inputLocked = true;
            isGhostMode = true;
            document.getElementById('ghost-controls').style.display = 'block';
            document.getElementById('ui-layer').style.opacity = '0.3';
            ghostPos.x = width / 2;
            ghostPos.y = height / 2;
            ghostTrail = [];
            timer = 0;
        }

        function playGhostGame() {
            // Add trail
            if(frameCount % 3 === 0) {
                ghostTrail.push({x: ghostPos.x, y: ghostPos.y, alpha: 100});
            }

            timer++;
            if(timer > 300) {
                // Auto-end after exploration
                document.getElementById('ghost-controls').style.display = 'none';
                document.getElementById('ui-layer').style.opacity = '1';
                endGame();
            }
        }

        function moveGhost(dx, dy) {
            if(gameState === "GHOST_GAME") {
                ghostPos.x += dx * 20;
                ghostPos.y += dy * 20;

                // Wrap around screen
                if(ghostPos.x < 0) ghostPos.x = width;
                if(ghostPos.x > width) ghostPos.x = 0;
                if(ghostPos.y < 0) ghostPos.y = height;
                if(ghostPos.y > height) ghostPos.y = 0;
            }
        }

        function uiSet(txt) {
            document.getElementById('minigame-ui').style.display = 'block';
            document.getElementById('game-title').innerText = txt;
            document.getElementById('game-title').style.color = '#FFE600';
            document.getElementById('arrow').style.display = 'none';
            document.getElementById('ui-layer').style.opacity = '0.2';
        }

        function endGame() {
            gameState = "STORY"; inputLocked = false;
            document.getElementById('minigame-ui').style.display = 'none';
            document.getElementById('arrow').style.display = 'block';
            document.getElementById('ui-layer').style.opacity = '1';
            advanceStory();
        }

        // INPUT
        function mousePressed() {
            handleRageTap();
            handleTeddieTap(mouseX, mouseY);
            return false;
        }

        function touchStarted(event) {
            if(event) event.preventDefault();
            if(touches.length > 0) {
                handleRageTap();
                handleTeddieTap(touches[0].x, touches[0].y);
            }
            return false;
        }

        function touchMoved(event) {
            if(event) event.preventDefault();
            return false;
        }

        // Keyboard controls for ghost mode
        function keyPressed() {
            if(gameState === "GHOST_GAME") {
                if(keyCode === UP_ARROW) moveGhost(0, -1);
                else if(keyCode === DOWN_ARROW) moveGhost(0, 1);
                else if(keyCode === LEFT_ARROW) moveGhost(-1, 0);
                else if(keyCode === RIGHT_ARROW) moveGhost(1, 0);
            }
        }

        // Setup button handlers
        document.getElementById('bet-fall').addEventListener('click', () => handleBet(0));
        document.getElementById('bet-spill').addEventListener('click', () => handleBet(1));
        document.getElementById('bet-break').addEventListener('click', () => handleBet(2));

        // Ghost mode touch controls
        document.getElementById('arrow-up').addEventListener('click', () => moveGhost(0, -1));
        document.getElementById('arrow-down').addEventListener('click', () => moveGhost(0, 1));
        document.getElementById('arrow-left').addEventListener('click', () => moveGhost(-1, 0));
        document.getElementById('arrow-right').addEventListener('click', () => moveGhost(1, 0));

        // Cleanup button
        document.getElementById('cleanup-btn').addEventListener('click', () => {
            document.getElementById('cleanup-btn').innerText = 'CLEARING...';
            setTimeout(() => {
                document.getElementById('cleanup-btn').style.display = 'none';
                document.getElementById('ui-layer').innerHTML = '<div class="text-box" style="text-align:center; pointer-events:none;"><span style="color:#00FF00;">MEMORY CLEARED</span><br><span style="font-size:clamp(0.8rem, 3vw, 1rem);">Connection persists. Always.</span></div>';
            }, 1000);
        });

        let currentIndex = -1;
        function handleInput() { if(inputLocked || gameState === 'END') return; advanceStory(); }

        function advanceStory() {
            currentIndex++;
            if(currentIndex >= story.length) return;
            const s = story[currentIndex];

            if(s.type === 'minigame_rage') { startRageGame(); return; }
            if(s.type === 'minigame_teddie') { startTeddieGame(); return; }
            if(s.type === 'minigame_betting') { startBettingGame(); return; }
            if(s.type === 'minigame_ghost') { startGhostGame(); return; }

            document.getElementById('typing-text').innerHTML = s.text;

            if(s.effect === 'kanjiSteam') charAnim.kanjiShake = 60;
            if(s.effect === 'scanStart') charAnim.riseGlow = true;
            if(s.effect === 'scanEnd') charAnim.riseGlow = false;
            if(s.effect === 'ghostModeStart') isGhostMode = true;
            if(s.effect === 'ending') {
                gameState = 'END';
                document.getElementById('canvas-container').style.opacity = "0.3";
                document.getElementById('speaker').style.display = 'none';
                document.getElementById('ui-layer').style.opacity = '0.3';
                document.getElementById('cleanup-btn').style.display = 'block';
            }

            if(s.anim === 'shakeKanji') charAnim.kanjiShake = 40;
            if(s.anim === 'glitchNaoto') charAnim.naotoGlitch = 60;
            if(s.anim === 'bounceRise') charAnim.riseBounce = 60;
            if(s.anim === 'spinTeddie') charAnim.teddieSpin = 60;
            if(s.anim === 'shakeTeddie') charAnim.teddieShake = 60;
            if(s.anim === 'sadRise') charAnim.riseBounce = 30;

            const spk = document.getElementById('speaker');
            if(s.speaker) {
                spk.style.display = 'block'; spk.innerText = s.speaker;
                spk.style.backgroundColor = (s.speaker==='Kanji'?'#ff5252': s.speaker==='Naoto'?'#448aff': s.speaker==='Rise'?'#ff4081': s.speaker==='Teddie'?'#03A9F4':'#fff');
            } else { spk.style.display = 'none'; }
        }

        // UTILS
        class Steam {
            constructor(x,y) { this.x=x; this.y=y; this.life=255; }
            update() { this.y-=3; this.x+=random(-1,1); this.life-=8; }
            show() { fill(255, this.life); noStroke(); rect(this.x, this.y, 8, 8); }
            get done() { return this.life < 0; }
        }
        class Cloud {
            constructor(){this.reset();}
            reset(){this.x=random(width); this.y=random(height*0.2); this.speed=random(0.3, 1.0); this.size = random(80, 150);}
            update(){this.x+=this.speed; if(this.x>width+this.size)this.x=-this.size; if(frameCount%900==0)this.reset();}
            show(){noStroke(); fill(255, 200); rect(this.x,this.y,this.size,this.size*0.4,20);}
        }
        class Confetti {
            constructor(x,y){this.x=x;this.y=y;this.c=color(random(255),random(255),random(255)); this.vy = random(-5, -2); this.vx = random(-2,2);}
            update(){this.y+=3; this.x+=this.vx; this.y-=this.vy; this.vy+=0.1;}
            show(){fill(this.c);noStroke();rect(this.x,this.y,6,6);}
        }
        function drawFloor() {
            noStroke();
            let horizon=height/2+50;
            // Lighter floor for noon
            for(let y=horizon;y<height;y+=25){
                for(let x=0;x<width;x+=50){
                    fill((x+y)%100===0?120:140);
                    let p=map(y,horizon,height,0.5,1.5);
                    rect(x,y,50*p,25);
                }
            }
        }
        function setGradient(x,y,w,h,c1,c2){ noFill(); for(let i=y;i<=y+h;i++){ let inter=map(i,y,y+h,0,1); stroke(lerpColor(c1,c2,inter)); line(x,i,x+w,i);}}
    </script>
</body>
</html>
